<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js')
          .then(function(registration) {
            console.log('ServiceWorker Ù…Ø³Ø¬Ù„:', registration);
          }, function(err) {
            console.log('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ ServiceWorker:', err);
          });
      });
    }
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙ‚ÙˆÙŠÙ… Ø­Ø¬Ø² Ø´Ø§Ù„ÙŠÙ‡ Ø³Ø§Ù†ØªÙˆØ±ÙŠÙ†ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * { font-family: 'Tajawal', sans-serif; }
    body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  margin: 0;
  padding: 0;
  background: linear-gradient(to bottom right, #f5f5f5, #eaeaea);
}
body.rest1-bg {
  background-image: url('https://i.ibb.co/nMndmjYX/Whats-App-Image-2025-06-20-at-6-12-26-PM.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: calc(100% - 20px);
      max-width: 400px;
      margin-bottom: 10px;
    }
    .controls button {
      padding: 6px 12px;
      font-size: 14px;
      background-color: #20B2AA;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #monthLabel {
      font-weight: bold;
      font-size: 16px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      width: calc(100% - 20px);
      max-width: 400px;
      margin-top: 10px;
    }
    .day {
      background-color: #20B2AA;
      color: white;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      min-height: 90px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .top-number {
      font-size: 18px;
      padding-top: 5px;
    }
    .day .bar {
      position: absolute;
      left: 0;
      width: 100%;
      background-color: #8B0000;
      color: white;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 2px;
    }
    .bar1 { top: 30%; height: 20%; }
    .bar2 { top: 50%; height: 20%; }
    .bar3 { top: 70%; height: 20%; font-weight: bold; }
    .full-red { background-color: darkred !important; }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 9999;
      width: 92%;
      max-width: 360px;
    }
    .popup input, .popup select, .popup textarea {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      font-size: 14px;
    }
    .popup label {
      margin-top: 10px;
      font-weight: bold;
      display: block;
    }
    .popup button.save {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background-color: #20B2AA;
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    #expensesButton {
      font-size: 20px;
      background-color: #FFA500;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 1000;
    }
body.rest1-bg::before {
  content: "";
  position: fixed;
  inset: 0;
  background-color: rgba(255, 255, 255, 0.7); /* Ø·Ø¨Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ø´ÙØ§ÙØ© */
  z-index: -1;
}
body.rest2-bg {
  background-image: url('https://i.ibb.co/qLn9MVQd/Whats-App-Image-2025-06-20-at-6-11-48-PM.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
body.rest2-bg::before {
  content: "";
  position: fixed;
  inset: 0;
  background-color: rgba(255, 255, 255, 0.7); /* Ø·Ø¨Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ø´ÙØ§ÙØ© */
  z-index: -1;
}
body.rest3-bg {
  background-image: url('https://i.ibb.co/1J2s88NP/Whats-App-Image-2025-06-20-at-6-11-20-PM.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
body.rest3-bg::before {
  content: "";
  position: fixed;
  inset: 0;
  background-color: rgba(255, 255, 255, 0.7); /* Ø·Ø¨Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ø´ÙØ§ÙØ© */
  z-index: -1;
}

  </style>
</head>
<body>
<!-- ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminSetup" style="display:none;position:fixed;inset:0;background:white;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
  <input type="password" id="newAdminPwd" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
  <button onclick="saveAdminPwd()">Ø­ÙØ¸</button>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ -->
<div id="loginOverlay" style="display:none;position:fixed;inset:0;background:white;z-index:9998;display:flex;flex-direction:column;justify-content:center;align-items:center;">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <select id="roleSelect">
    <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
    <option value="admin">Ø£Ø¯Ù…Ù†</option>
  </select>
  <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
  <button onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminPanel" style="display:none;position:fixed;top:10px;left:10px;background:white;border:1px solid #ccc;padding:10px;z-index:1000;">
  <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
  <input type="password" id="newUserPwd" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <button onclick="saveUserPwd()">Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div style="margin-bottom: 10px;">
  <a href="https://ibb.co/vCHDtfQP" target="_blank">
    <img src="https://i.ibb.co/tw43dnxs/1000760892.jpg" alt="Ø´Ø¹Ø§Ø±" style="max-width: 80px; height: auto; border-radius: 12px;">
  </a>
</div>
<div style="margin-bottom: 10px; display: flex; gap: 10px;">
  <button id="btn-rest1" onclick="switchRest('rest1')" style="padding: 6px 12px; background:#4682B4; color:white; border:none; border-radius:8px;">Ø§Ø³ØªØ±Ø§Ø­Ø© 1</button>
  <button id="btn-rest2" onclick="switchRest('rest2')" style="padding: 6px 12px; background:#4682B4; color:white; border:none; border-radius:8px;">Ø§Ø³ØªØ±Ø§Ø­Ø© 2</button>
  <button id="btn-rest3" onclick="switchRest('rest3')" style="padding: 6px 12px; background:#4682B4; color:white; border:none; border-radius:8px;">Ø§Ø³ØªØ±Ø§Ø­Ø© 3</button>
</div>

<div class="controls">
  <button onclick="changeMonth(-1)">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
  <div id="monthLabel"></div>
  <button onclick="changeMonth(1)">Ø§Ù„ØªØ§Ù„ÙŠ</button>
</div>
<div class="days-row" style="display: grid; grid-template-columns: repeat(7, 1fr); width: calc(100% - 20px); max-width: 400px; text-align: center; font-weight: bold; margin-top: 10px;">
  <div>Ø§Ù„Ø£Ø­Ø¯</div>
  <div>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</div>
  <div>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div>
  <div>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div>
  <div>Ø§Ù„Ø®Ù…ÙŠØ³</div>
  <div>Ø§Ù„Ø¬Ù…Ø¹Ø©</div>
  <div>Ø§Ù„Ø³Ø¨Øª</div>
</div>
<div class="calendar" id="calendar"></div>
<div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
  <button id="expensesButton" onclick="openExpenses()" style="font-size: 16px; background-color: #4682B4; color: white; padding: 10px 20px; border: none; border-radius: 12px; cursor: pointer;">
    ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  </button>
  <button id="reportButton" onclick="openReport()" style="font-size: 16px; background-color: #4682B4; color: white; padding: 10px 20px; border: none; border-radius: 12px; cursor: pointer;">
    ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  </button>
</div>


<div class="popup" id="expensesPopup">
  <button onclick="document.getElementById('expensesPopup').style.display='none'"
          style="position:absolute;top:10px;left:10px;background:#eee;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">Ã—</button>
  <h3 style="text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3>
  <label for="expenseType">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ:</label>
  <select id="expenseType" onchange="handleExpenseTypeChange()">
    <option value="">-- Ø§Ø®ØªØ± --</option>
    <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
    <option value="Ù…Ø§Ø¡">Ù…Ø§Ø¡</option>
    <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
    <option value="ØªÙ†Ø¸ÙŠÙ">ØªÙ†Ø¸ÙŠÙ</option>
    <option value="Ø§Ù†ØªØ±Ù†Øª">Ø§Ù†ØªØ±Ù†Øª</option>
    <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
  </select>
  <div id="otherExpenseContainer" style="display:none;">
    <label for="otherExpense">Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ:</label>
    <input type="text" id="otherExpense" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¶ÙŠØ§ÙØ©"/>
  </div>
  <label for="expenseAmount">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
  <input type="number" id="expenseAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹: 10"/>
<div style="display:flex; gap:10px; margin-top:10px;">
  <button class="save" style="flex:1;" onclick="saveExpense()">Ø­ÙØ¸</button>
  <button class="save" style="flex:1; background:#b22222;" onclick="removeExpense()">Ø­Ø°Ù</button>
</div>


<div id="expenseList" style="margin-top:15px;"></div>
<div id="totalExpense" style="margin-top:10px; font-weight:bold; text-align:center;"></div>
</div>
<div class="popup" id="reportPopup" style="display:none;">
  <button onclick="document.getElementById('reportPopup').style.display='none'"
          style="position:absolute;top:10px;left:10px;background:#eee;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">Ã—</button>
  <h3 style="text-align:center;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
<label for="reportStart">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
<input type="date" id="reportStart">

<label for="reportEnd">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
<input type="date" id="reportEnd">

  <button class="save" onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  <div id="reportResults" style="margin-top:15px;"></div>
</div>
<div class="popup" id="popup">
  <button onclick="document.getElementById('popup').style.display='none'" style="position:absolute;top:10px;left:10px;background:#eee;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">Ã—</button>
  <h3 style="text-align:center;">Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø¬Ø²</h3>
  <label>Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø­Ø¬Ø² 1:</label>
  <input type="text" id="from1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 8-12">
  <label>Ù…Ø¨Ù„Øº Ø­Ø¬Ø² 1:</label>
  <input type="text" id="amount1">
  <label>Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø­Ø¬Ø² 2:</label>
  <input type="text" id="from2" placeholder="Ù…Ø«Ù„Ø§Ù‹: 4-8">
  <label>Ù…Ø¨Ù„Øº Ø­Ø¬Ø² 2:</label>
  <input type="text" id="amount2">
  <label>Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</label>
  <select id="stay">
    <option value="">Ø¨Ø¯ÙˆÙ† Ù…Ø¨ÙŠØª</option>
    <option value="Ù…Ø¨ÙŠØª">Ù…Ø¨ÙŠØª</option>
  </select>
  <label>Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨ÙŠØª:</label>
  <input type="text" id="amount3">
  <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
  <textarea id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
  <button class="save" onclick="saveBooking()">Ø­ÙØ¸</button>
</div>
<div id="expenseList" style="margin-top:15px;"></div>
<div id="totalExpense" style="margin-top:10px; font-weight:bold; text-align:center;"></div>

</div>
<script>
(function(){
  const firebaseConfig = {
    apiKey: "AIzaSyCG17oEvXw-B0MBkZPLaCBYncuIOwgrsOo",
    authDomain: "test-f9621.firebaseapp.com",
    projectId: "test-f9621"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let selectedDate = "";
  let currentRest = localStorage.getItem("selectedRest") || "rest1";
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  const calendar = document.getElementById("calendar");

  function updateMonthLabel() {
    const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    document.getElementById("monthLabel").textContent = `${monthNames[currentMonth]} ${currentYear}`;
  }

  function renderCalendar() {
  updateMonthLabel();
  calendar.innerHTML = "";
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const cell = document.createElement("div");
    cell.className = "day";
    const dateId = `${currentYear}-${currentMonth + 1}-${d}`;
    cell.innerHTML = `<div class='top-number'>${d}</div>`;

    // Ø¶Ø¹ Ø§Ù„Ø®Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¢Ù†
    calendar.appendChild(cell);

    // Ø£Ø¶Ù Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¢Ù†
    cell.addEventListener("click", () => openPopup(dateId));

    // Ø«Ù… Ø§Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
    db.collection('rests').doc(currentRest).collection('bookings').doc(dateId).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();

        if (data.from1) {
          cell.innerHTML += `<div class='bar bar1'>${data.from1}</div>`;
        }
        if (data.from2) {
          cell.innerHTML += `<div class='bar bar2'>${data.from2}</div>`;
        }
        if (data.stay && data.stay === 'Ù…Ø¨ÙŠØª') {
          cell.innerHTML += `<div class='bar bar3'>Ù…Ø¨ÙŠØª</div>`;
          cell.classList.add("full-red");
        }
      }
    });
  }
}

  function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    } else if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
    updateExpenseList();
  }

  function openPopup(dateId) {
    selectedDate = dateId;
    db.collection('rests').doc(currentRest).collection('bookings').doc(dateId).get().then(doc => {
      const data = doc.exists ? doc.data() : {};
      document.getElementById("from1").value = data.from1 || "";
      document.getElementById("amount1").value = data.amount1 || "";
      document.getElementById("from2").value = data.from2 || "";
      document.getElementById("amount2").value = data.amount2 || "";
      document.getElementById("stay").value = data.stay || "";
      document.getElementById("amount3").value = data.amount3 || "";
      document.getElementById("note").value = data.note || "";
      document.getElementById("popup").style.display = "block";
    });
  }

  function saveBooking() {
  const data = {
    from1: document.getElementById("from1").value,
    amount1: document.getElementById("amount1").value,
    from2: document.getElementById("from2").value,
    amount2: document.getElementById("amount2").value,
    stay: document.getElementById("stay").value,
    amount3: document.getElementById("amount3").value,
    note: document.getElementById("note").value
  };

  db.collection('rests').doc(currentRest).collection('bookings').doc(selectedDate).set(data).then(() => {
    renderCalendar();
    document.getElementById("popup").style.display = "none"; // â† Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù†
  });
}


  function handleExpenseTypeChange() {
    const type = document.getElementById("expenseType").value;
    const container = document.getElementById("otherExpenseContainer");
    container.style.display = type === "Ø£Ø®Ø±Ù‰" ? "block" : "none";
  }

function openExpenses() {
  // Ø£ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  document.getElementById("reportPopup").style.display = "none";

  // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  document.getElementById("expensesPopup").style.display = "block";
  updateExpenseList();
}


  function saveExpense() {
    const year = currentYear;
    const month = currentMonth + 1;


    const type = document.getElementById("expenseType").value;
    const other = document.getElementById("otherExpense").value;
    const amount = parseFloat(document.getElementById("expenseAmount").value);

    if (!type || !amount) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº");
      return;
    }

    const finalType = type === "Ø£Ø®Ø±Ù‰" ? other : type;
    const docRef = db.collection("rests").doc(currentRest).collection("expenses")
                     .doc(`${year}-${month}`).collection("items").doc(finalType);

    docRef.get().then(doc => {
      const oldAmount = doc.exists ? parseFloat(doc.data().amount || 0) : 0;
      const newAmount = oldAmount + amount;
      docRef.set({ amount: newAmount });
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­");
updateExpenseList();
// document.getElementById("expensesPopup").style.display = "none";

    });
  }
function removeExpense() {
  const year = currentYear;
  const month = currentMonth + 1;


  const type = document.getElementById("expenseType").value;
  const other = document.getElementById("otherExpense").value;
  const amount = parseFloat(document.getElementById("expenseAmount").value);

  if (!type || !amount) {
    alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº");
    return;
  }

  const finalType = type === "Ø£Ø®Ø±Ù‰" ? other : type;
  const docRef = db.collection("rests").doc(currentRest).collection("expenses")
                   .doc(`${year}-${month}`).collection("items").doc(finalType);

  docRef.get().then(doc => {
    const oldAmount = doc.exists ? parseFloat(doc.data().amount || 0) : 0;
    const newAmount = oldAmount - amount;
    if (newAmount <= 0) {
      docRef.delete();
    } else {
      docRef.set({ amount: newAmount });
    }
    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­");
updateExpenseList();
// document.getElementById("expensesPopup").style.display = "none";

  });
}


  function updateExpenseList() {
  const year = currentYear;
  const month = currentMonth + 1;
  const listDiv = document.getElementById("expenseList");
  const totalDiv = document.getElementById("totalExpense");

  db.collection("rests").doc(currentRest).collection("expenses")
    .doc(`${year}-${month}`).collection("items")
    .get().then(snapshot => {
      let total = 0;
      let html = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const amount = parseFloat(data.amount || 0);
        total += amount;
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
           <span>${doc.id}</span>
           <span>${amount.toFixed(2)} Ø±ÙŠØ§Ù„</span>
         </div>`;

      });
      listDiv.innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©.";
      totalDiv.textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: " + total.toFixed(2) + " Ø±ÙŠØ§Ù„";
    });
}
function deleteExpense(type) {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const docRef = db.collection("rests").doc(currentRest).collection("expenses")
                   .doc(`${year}-${month}`).collection("items").doc(type);

  docRef.get().then(doc => {
    if (doc.exists) {
      const currentAmount = parseFloat(doc.data().amount || 0);
      let amountToSubtract = parseFloat(prompt("ÙƒÙ… ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø¨Ù„ØºØŸ", "0")) || 0;
      if (amountToSubtract > currentAmount) {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ø¬Ù„.");
        return;
      }
      const newAmount = currentAmount - amountToSubtract;
      if (newAmount <= 0) {
        docRef.delete();
      } else {
        docRef.set({ amount: newAmount });
      }
      updateExpenseList();
    }
  });
}
function switchRest(restId) {
  currentRest = restId;
  localStorage.setItem("selectedRest", restId);

  document.body.classList.remove("rest1-bg", "rest2-bg", "rest3-bg");

  if (restId === "rest1") {
    document.body.classList.add("rest1-bg");
  } else if (restId === "rest2") {
    document.body.classList.add("rest2-bg");
  } else if (restId === "rest3") {
    document.body.classList.add("rest3-bg");
  }

  // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.getElementById("btn-rest1").style.backgroundColor = "#4682B4";
  document.getElementById("btn-rest2").style.backgroundColor = "#4682B4";
  document.getElementById("btn-rest3").style.backgroundColor = "#4682B4";

  document.getElementById(`btn-${restId}`).style.backgroundColor = "#FF8C00"; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ù…ÙŠØ²

  renderCalendar();
  updateExpenseList();
}







  window.changeMonth = changeMonth;
  window.openPopup = openPopup;
  window.saveBooking = saveBooking;
  window.openExpenses = openExpenses;
  window.handleExpenseTypeChange = handleExpenseTypeChange;
  window.saveExpense = saveExpense;
  window.deleteExpense = deleteExpense;
  window.removeExpense = removeExpense;
  window.openReport = openReport;
  window.generateReport = generateReport;
  window.switchRest = switchRest;

  


function openReport() {
  // Ø£ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  document.getElementById("expensesPopup").style.display = "none";

  // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  document.getElementById("reportPopup").style.display = "block";
}


function generateReport() {
  const startInput = document.getElementById("reportStart").value;
  const endInput = document.getElementById("reportEnd").value;
  const resultsDiv = document.getElementById("reportResults");

  if (!startInput || !endInput) {
    resultsDiv.innerHTML = "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø© ØµØ§Ù„Ø­Ø©.";
    return;
  }

  const startParts = startInput.split("-");
  const endParts = endInput.split("-");

  const start = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
  const end = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));

  if (isNaN(start) || isNaN(end)) {
    resultsDiv.innerHTML = "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø© ØµØ§Ù„Ø­Ø©.";
    return;
  }

  let totalExpenses = 0;
  let totalIncome = 0;
  let bookedDays = 0;
  const monthsToCheck = [];
  const tempDate = new Date(start);

  while (tempDate <= end) {
    const y = tempDate.getFullYear();
    const m = tempDate.getMonth() + 1;
    const id = `${y}-${m}`;
    if (!monthsToCheck.includes(id)) monthsToCheck.push(id);
    tempDate.setMonth(tempDate.getMonth() + 1);
  }

  let expensesDone = 0;
  let bookingsChecked = 0;
  let totalBookingDocs = [];

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  monthsToCheck.forEach(monthId => {
    db.collection("rests").doc(currentRest).collection("expenses")
      .doc(monthId).collection("items")
      .get().then(snapshot => {
        snapshot.forEach(doc => {
          const amount = parseFloat(doc.data().amount || 0);
          totalExpenses += amount;
        });
        expensesDone++;
        if (expensesDone === monthsToCheck.length && bookingsChecked === totalBookingDocs.length) {
          displayFinal();
        }
      });
  });

  // Ø¬Ù…Ø¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ¹Ø¯Ù‘ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
  const allDates = [];
  const loopDate = new Date(start);
  while (loopDate <= end) {
    const y = loopDate.getFullYear();
    const m = loopDate.getMonth() + 1;
    const d = loopDate.getDate();
    const id = `${y}-${m}-${d}`;
    allDates.push(id);
    loopDate.setDate(loopDate.getDate() + 1);
  }

  totalBookingDocs = allDates;

  allDates.forEach(dateId => {
    db.collection("rests").doc(currentRest).collection("bookings").doc(dateId)
      .get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          const a1 = parseFloat(data.amount1 || 0);
          const a2 = parseFloat(data.amount2 || 0);
          const a3 = parseFloat(data.amount3 || 0);
          if (a1 > 0) { totalIncome += a1; bookedDays++; }
          if (a2 > 0) { totalIncome += a2; bookedDays++; }
          if (a3 > 0) { totalIncome += a3; bookedDays++; }
        }
        bookingsChecked++;
        if (expensesDone === monthsToCheck.length && bookingsChecked === totalBookingDocs.length) {
          displayFinal();
        }
      });
  });

  function displayFinal() {
    const profit = totalIncome - totalExpenses;
    resultsDiv.innerHTML = `
      <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©:</strong> ${bookedDays} ÙŠÙˆÙ…</div>
      <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„:</strong> ${totalIncome.toFixed(2)} Ø±ÙŠØ§Ù„</div>
      <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${totalExpenses.toFixed(2)} Ø±ÙŠØ§Ù„</div>
      <hr>
      <div><strong>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­:</strong> ${profit.toFixed(2)} Ø±ÙŠØ§Ù„</div>
    `;
  }
}





})();
</script>

<button id="installBtn" style="position: fixed; bottom: 20px; right: 20px; background-color: #bfa16b; color: white; padding: 10px 20px; border: none; border-radius: 12px; font-size: 16px; z-index: 9999;">ğŸ“² ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>


<script>
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => {
        if (choice.outcome === 'accepted') {
          console.log('App installed');
        }
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });
    } else {
      alert("Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ iPhoneØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø«Ù… 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'.");
    }
  });
const db = firebase.firestore();

function showAdminSetup() {
  document.getElementById("adminSetup").style.display = "flex";
}

function showLogin() {
  document.getElementById("loginOverlay").style.display = "flex";
}



function saveAdminPwd() {
  const pwd = document.getElementById('newAdminPwd').value.trim();
  if (!pwd) {
    alert("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
    return;
  }
  db.collection("roles").doc("admin").set({ password: pwd }).then(() => {
    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø£Ø¯Ù…Ù†");
    document.getElementById("adminSetup").style.display = "none";
    showLogin();
  });
}

function checkLogin() {
  const role = document.getElementById('roleSelect').value;
  const pwd = document.getElementById('passwordInput').value.trim();

  db.collection("roles").doc(role).get().then(doc => {
    if (doc.exists) {
      const correctPwd = doc.data().password;
      if (pwd === correctPwd) {
        localStorage.setItem("role", role);
        document.getElementById("loginOverlay").style.display = "none";
        if (role === "admin") {
          document.getElementById("adminPanel").style.display = "block";
        }
switchRest(currentRest);
      } else {
        document.getElementById("loginError").textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
      }
    } else {
      document.getElementById("loginError").textContent = "Ø§Ù„Ø¯ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    }
  }).catch(err => {
    console.error(err);
    document.getElementById("loginError").textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
  });
}

function saveUserPwd() {
  const pwd = document.getElementById('newUserPwd').value.trim();
  if (!pwd) {
    alert("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
    return;
  }
  db.collection("roles").doc("user").set({ password: pwd }).then(() => {
    alert("ØªÙ… Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  });
}

function logout() {
  localStorage.removeItem("role");
  location.reload();
}

// ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener("load", () => {
  const savedRole = localStorage.getItem("role");
  if (savedRole) {
    if (savedRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
    }
     switchRest(currentRest);
    return;
  }

  db.collection("roles").doc("admin").get().then(doc => {
    if (!doc.exists) {
      // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ù„Ø£Ø¯Ù…Ù† â†’ Ø£Ù†Ø´Ø¦Ù‡Ø§
      showAdminSetup();
    } else {
      showLogin();
    }
  });
});


  installBtn.style.display = 'none';
</script>

</body>
</html>
