<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>لوحة إدارة الشاليهات</title>
<script type="module" src="./firebase-config.js"></script>
<script type="module">
import { auth, db } from "./firebase-config.js";
import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, query, where, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const loginDiv = document.getElementById("login");
const adminDiv = document.getElementById("admin");
const chaletSelect = document.getElementById("chaletSelect");
const bookingsDiv = document.getElementById("bookings");

const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");

onAuthStateChanged(auth, user => {
  if (user) {
    loginDiv.style.display = "none";
    adminDiv.style.display = "block";
    loadChalets(user.uid);
  } else {
    loginDiv.style.display = "block";
    adminDiv.style.display = "none";
  }
});

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = loginForm.email.value;
  const password = loginForm.password.value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    alert(err.message);
  }
});

logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
});

async function loadChalets(ownerId) {
  chaletSelect.innerHTML = "";
  const q = query(collection(db, "chalets"), where("ownerId", "==", ownerId));
  const snap = await getDocs(q);
  snap.forEach(doc => {
    const opt = document.createElement("option");
    opt.value = doc.id;
    opt.textContent = doc.data().name;
    chaletSelect.appendChild(opt);
  });
  if (chaletSelect.options.length > 0) {
    loadBookings(chaletSelect.value);
  }
}

chaletSelect.addEventListener("change", () => {
  loadBookings(chaletSelect.value);
});

async function loadBookings(chaletId) {
  bookingsDiv.innerHTML = "";
  const q = query(collection(db, "bookings"), where("chaletId", "==", chaletId));
  const snap = await getDocs(q);
  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.textContent = `${d.date} — ${d.period} — ${d.guestName} — ${d.status}`;
    bookingsDiv.appendChild(div);
  });
}
</script>
<style>
body { font-family: Arial; padding: 20px; }
#login, #admin { max-width: 400px; margin: auto; }
</style>
</head>
<body>
<div id="login">
<h3>تسجيل دخول الإدارة</h3>
<form id="loginForm">
<input type="email" name="email" placeholder="الإيميل"><br>
<input type="password" name="password" placeholder="كلمة المرور"><br>
<button type="submit">دخول</button>
</form>
</div>

<div id="admin" style="display:none">
<h3>الإدارة</h3>
<button id="logoutBtn">تسجيل خروج</button><br><br>
<select id="chaletSelect"></select><br><br>
<div id="bookings"></div>
</div>
</body>
</html>
